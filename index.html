<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bajo la Luz de la Luna</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500&family=Quicksand:wght@300&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: #050510; /* Fondo base muy oscuro */
            font-family: 'Quicksand', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        canvas { display: block; }
        
        /* UI Elegante */
        #ui-layer {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 105, 180, 0.6);
            margin: 0;
            opacity: 0.9;
            letter-spacing: 2px;
        }
        p { color: rgba(200, 200, 255, 0.7); font-size: 0.9rem; margin-top: 5px; }

        /* Tarjeta con efecto Cristal (Glassmorphism) */
        #message-card {
            pointer-events: auto;
            background: rgba(20, 20, 40, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            color: #fff;
            max-width: 280px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 100;
        }
        #message-card.active { transform: translate(-50%, -50%) scale(1); opacity: 1;}
        #message-text { font-size: 1.2rem; margin-bottom: 20px; font-weight: 500; color: #ffe4e1; }
        
        .close-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
            transition: transform 0.2s;
        }
        .close-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div id="ui-layer">
        <h1>Jardín Lunar</h1>
        <p>Un regalo interactivo · Toca al conejo</p>
    </div>

    <div id="message-card">
        <div id="message-text">...</div>
        <button class="close-btn" onclick="closeMessage()">Guardar Recuerdo</button>
    </div>

    <canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let width, height;

    // --- CONFIGURACIÓN ---
    const dedicatorias = [
        "Tu sonrisa ilumina todo.", "Eres mi lugar seguro.", "Gracias por existir.",
        "Esto es solo para ti.", "Me encantas.", "Eres arte.", 
        "Siempre te cuidaré.", "Un abrazo virtual.", "Eres increíble."
    ];

    let flores = [];
    let particulas = [];
    let estrellas = [];
    let conejo;
    let moonAlpha = 0;

    // Resize
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        conejo = new Conejo(width/2, height * 0.88);
    }
    window.addEventListener('resize', resize);

    // --- CLASES VISUALES MEJORADAS ---

    class Particula {
        constructor(x, y, color) {
            this.x = x; this.y = y;
            this.vx = (Math.random() - 0.5) * 3;
            this.vy = (Math.random() - 0.5) * 3;
            this.life = 1;
            this.color = color || '#FFF';
            this.size = Math.random() * 3;
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            this.life -= 0.02;
            this.size *= 0.95;
        }
        draw() {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    class Conejo {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.scale = 1;
            this.blinkTimer = 0;
            this.nextBlink = 100; // Frames para parpadear
            this.wiggle = 0;
            this.actionTimer = 0;
        }
        update() {
            this.nextBlink--;
            if(this.nextBlink <= 0) {
                this.blinkTimer = 10; // Duración del parpadeo
                this.nextBlink = Math.random() * 200 + 100;
            }
            if(this.blinkTimer > 0) this.blinkTimer--;
            
            if(this.actionTimer > 0) {
                this.actionTimer--;
                this.wiggle = Math.sin(this.actionTimer * 0.5) * 0.1;
            } else {
                this.wiggle = 0;
            }
            // Respiración suave
            this.scale = 1 + Math.sin(Date.now()*0.003)*0.015; 
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.scale(this.scale, this.scale + (this.wiggle*0.5));
            ctx.rotate(this.wiggle);

            // Sombra del conejo en el suelo
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath(); ctx.ellipse(0, 55, 60, 10, 0, 0, Math.PI*2); ctx.fill();

            // Cuerpo con gradiente (Volumen)
            let gradBody = ctx.createRadialGradient(-20, 20, 10, 0, 40, 80);
            gradBody.addColorStop(0, '#FFFFFF');
            gradBody.addColorStop(1, '#E0E0E0');
            ctx.fillStyle = gradBody;
            ctx.beginPath(); ctx.ellipse(0, 40, 70, 55, 0, 0, Math.PI*2); ctx.fill();

            // Patitas
            ctx.beginPath(); ctx.ellipse(-40, 90, 25, 12, Math.PI/5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(40, 90, 25, 12, -Math.PI/5, 0, Math.PI*2); ctx.fill();

            // Cabeza
            let gradHead = ctx.createRadialGradient(-15, -15, 10, 0, 0, 55);
            gradHead.addColorStop(0, '#FFFFFF');
            gradHead.addColorStop(1, '#EEEEEE');
            ctx.fillStyle = gradHead;
            ctx.beginPath(); ctx.arc(0, 0, 50, 0, Math.PI*2); ctx.fill();

            // Orejas con profundidad
            this.drawEar(-35, -45, -0.2 + this.wiggle);
            this.drawEar(35, -45, 0.2 - this.wiggle);

            // Cara
            // Ojos
            if(this.blinkTimer > 0) {
                // Cerrados
                ctx.beginPath(); ctx.moveTo(-28, -5); ctx.quadraticCurveTo(-20, 0, -12, -5); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(12, -5); ctx.quadraticCurveTo(20, 0, 28, -5); ctx.stroke();
            } else {
                // Abiertos y brillantes
                ctx.fillStyle = '#111';
                ctx.beginPath(); ctx.ellipse(-20, -5, 6, 8, 0, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.ellipse(20, -5, 6, 8, 0, 0, Math.PI*2); ctx.fill();
                // Brillo ojo
                ctx.fillStyle = '#FFF';
                ctx.beginPath(); ctx.arc(-18, -8, 2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(22, -8, 2, 0, Math.PI*2); ctx.fill();
            }

            // Mejillas (Blush) con desenfoque
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#FF69B4';
            ctx.fillStyle = 'rgba(255, 182, 193, 0.5)';
            ctx.beginPath(); ctx.arc(-35, 15, 12, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(35, 15, 12, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            // Nariz bonita
            ctx.fillStyle = '#FF5555';
            ctx.beginPath(); ctx.arc(0, 15, 6, 0, Math.PI*2); ctx.fill();
            
            // Boca
            ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(0, 15, 10, 0.2, Math.PI-0.2); ctx.stroke(); // Sonrisa simple

            ctx.restore();
        }

        drawEar(x, y, angle) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            // Externa
            ctx.fillStyle = '#F0F0F0';
            ctx.beginPath(); ctx.ellipse(0, -30, 16, 45, 0, 0, Math.PI*2); ctx.fill();
            
            // Interna (Rosita suave)
            let gradEar = ctx.createLinearGradient(0, -10, 0, -60);
            gradEar.addColorStop(0, '#FFE4E1');
            gradEar.addColorStop(1, '#FFB6C1');
            ctx.fillStyle = gradEar;
            ctx.beginPath(); ctx.ellipse(0, -30, 8, 35, 0, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }
        
        interact() {
            this.actionTimer = 20; // Wiggle effect
            // Lanzar partículas
            for(let i=0; i<10; i++) {
                particulas.push(new Particula(this.x, this.y - 50, '#FFD700'));
            }
        }
    }

    class Astromelia {
        constructor(x, y) {
            this.x = x; this.y = y; this.size = 0; this.maxSize = 35 + Math.random() * 25;
            this.mensaje = dedicatorias[Math.floor(Math.random() * dedicatorias.length)];
            
            // Colores vibrantes
            const colors = [
                ['#ff0080', '#ff8c00'], // Sunset
                ['#e0115f', '#ffffff'], // Rubí
                ['#9932cc', '#dda0dd'], // Orquídea
                ['#ffd700', '#ff4500']  // Gold
            ];
            this.colorPair = colors[Math.floor(Math.random()*colors.length)];
            
            this.angle = (Math.random()-0.5)*0.3;
            this.growSpeed = 0.5 + Math.random()*0.5;
        }
        update() { if(this.size < this.maxSize) this.size += (this.maxSize - this.size)*0.08; }
        
        draw(time) {
            const wind = Math.sin(time*0.002 + this.x)*5;
            ctx.save();
            ctx.translate(this.x + wind, this.y);
            
            // Tallo
            ctx.beginPath(); 
            ctx.moveTo(-wind, height-this.y); // Base fija
            ctx.quadraticCurveTo(0, (height-this.y)/2, 0, 0);
            ctx.strokeStyle = '#2d5a27'; ctx.lineWidth = this.size*0.1; ctx.stroke();
            
            ctx.rotate(wind*0.005 + this.angle);

            // Glow effect para la noche
            ctx.shadowBlur = 15;
            ctx.shadowColor = this.colorPair[0];

            // Flor
            for(let i=0; i<6; i++) {
                ctx.save(); ctx.rotate(i*Math.PI/3);
                // Pétalo
                let grad = ctx.createRadialGradient(0, -this.size, 0, 0, -this.size, this.size);
                grad.addColorStop(0, this.colorPair[1]);
                grad.addColorStop(1, this.colorPair[0]);
                ctx.fillStyle = grad;
                
                ctx.beginPath();
                ctx.moveTo(0,0);
                ctx.bezierCurveTo(this.size*0.5, -this.size*0.2, this.size*0.8, -this.size*1.5, 0, -this.size*2);
                ctx.bezierCurveTo(-this.size*0.8, -this.size*1.5, -this.size*0.5, -this.size*0.2, 0, 0);
                ctx.fill();
                
                // Manchas solo internos
                if(i%2!==0) {
                    ctx.fillStyle = '#330000';
                    for(let k=0; k<5; k++) {
                        ctx.beginPath();
                        ctx.ellipse(0, -this.size*(0.5+Math.random()*0.5), this.size*0.02, this.size*0.06, 0,0,Math.PI*2);
                        ctx.fill();
                    }
                }
                ctx.restore();
            }
            ctx.shadowBlur = 0; // Reset glow
            ctx.restore();
        }
        checkClick(mx, my) { return Math.hypot(mx - this.x, my - this.y) < this.maxSize; }
    }

    // --- FONDO (Luna y Estrellas) ---
    function drawBackground() {
        // Cielo degradado
        let grad = ctx.createLinearGradient(0, 0, 0, height);
        grad.addColorStop(0, '#020111');
        grad.addColorStop(1, '#191923');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,width,height);

        // Luna
        ctx.shadowBlur = 50;
        ctx.shadowColor = 'rgba(255, 255, 200, 0.5)';
        ctx.fillStyle = '#FFFFF0';
        ctx.beginPath();
        ctx.arc(width - 100, 100, 60, 0, Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
        
        // Estrellas
        ctx.fillStyle = '#FFF';
        estrellas.forEach(e => {
            ctx.globalAlpha = Math.random();
            ctx.beginPath(); ctx.arc(e.x, e.y, e.s, 0, Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha = 1;
    }

    // Init
    resize();
    for(let i=0; i<150; i++) estrellas.push({x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, s: Math.random()*1.5});

    // Loop
    function animate(time) {
        drawBackground();
        
        // Flores (detrás del conejo)
        flores.forEach(f => { f.update(); f.draw(time); });
        
        // Conejo
        if(conejo) { conejo.update(); conejo.draw(); }

        // Partículas
        for(let i=particulas.length-1; i>=0; i--) {
            let p = particulas[i];
            p.update();
            p.draw();
            if(p.life <= 0) particulas.splice(i, 1);
        }

        requestAnimationFrame(animate);
    }
    animate(0);

    // Inputs
    function handleInput(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;

        // 1. Check Flor
        for(let f of flores) {
            if(f.checkClick(x,y)) { mostrarMensaje(f.mensaje); return; }
        }

        // 2. Check Conejo
        let distConejo = Math.hypot(x - conejo.x, y - (conejo.y - 40));
        if(distConejo < 80) {
            conejo.interact();
            // Nace flor mágica
            let newX = Math.random() > 0.5 ? conejo.x + 80 : conejo.x - 80;
            flores.push(new Astromelia(Math.max(20, Math.min(width-20, newX)), height * 0.9));
            return;
        }

        // 3. Plantar suelo
        if(y > height*0.6) {
            flores.push(new Astromelia(x, y));
            // Partículas al plantar
            for(let i=0; i<5; i++) particulas.push(new Particula(x, y, '#00FF00'));
        }
    }

    canvas.addEventListener('mousedown', handleInput);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive:false});

    // UI Logic
    const card = document.getElementById('message-card');
    function mostrarMensaje(txt) {
        document.getElementById('message-text').innerText = txt;
        card.classList.add('active');
    }
    function closeMessage() { card.classList.remove('active'); }

</script>
</body>
</html>
